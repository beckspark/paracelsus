services:
  # LocalStack - AWS services emulator
  localstack:
    image: localstack/localstack:3.4
    container_name: paracelsus-localstack
    ports:
      - "4566:4566"  # LocalStack Gateway
      - "4510-4559:4510-4559"  # External services port range
    environment:
      - DEBUG=1
      - SERVICES=s3,lambda,events,iam,logs
      - LAMBDA_EXECUTOR=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
      - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - "./localstack-data:/var/lib/localstack"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./terraform/lambda:/opt/code/localstack/lambda"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL OLTP (represents RDS in production)
  # Note: Using direct Postgres as LocalStack RDS Community has limitations
  oltp-db:
    image: postgres:16-alpine
    container_name: paracelsus-oltp
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: oltp_secret
      POSTGRES_DB: supervision
    ports:
      - "5433:5432"
    volumes:
      - oltp-data:/var/lib/postgresql/data
      - ./synthetic_data/init_oltp.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d supervision"]
      interval: 5s
      timeout: 5s
      retries: 5

  # PostgreSQL OLAP (Data Warehouse)
  olap-db:
    image: postgres:16-alpine
    container_name: paracelsus-olap
    environment:
      POSTGRES_USER: warehouse
      POSTGRES_PASSWORD: olap_secret
      POSTGRES_DB: analytics
    ports:
      - "5435:5432"
    volumes:
      - olap-data:/var/lib/postgresql/data
      - ./scripts/init_olap.sql:/docker-entrypoint-initdb.d/01_init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U warehouse -d analytics"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Mock HubSpot API (HTTPS on port 443 for tap-hubspot compatibility)
  mock-hubspot:
    build:
      context: ./mock_hubspot
      dockerfile: Dockerfile
    container_name: paracelsus-mock-hubspot
    ports:
      - "8443:443"  # HTTPS exposed on host port 8443
    environment:
      - PYTHONUNBUFFERED=1
    volumes:
      - hubspot-certs:/certs  # Share certs with meltano container
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost:443/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Meltano ELT (Extract, Load, Transform) - unified container
  # Includes dbt-postgres utility for running dbt transforms
  meltano:
    build:
      context: ./meltano
      dockerfile: Dockerfile
    container_name: paracelsus-meltano
    environment:
      - MELTANO_ENVIRONMENT=dev
      # tap-postgres (OLTP source)
      - TAP_POSTGRES_HOST=oltp-db
      - TAP_POSTGRES_PORT=5432
      - TAP_POSTGRES_USER=admin
      - TAP_POSTGRES_PASSWORD=oltp_secret
      - TAP_POSTGRES_DATABASE=supervision
      # tap-s3-csv (LocalStack S3)
      - TAP_S3_CSV_BUCKET=paracelsus-landing
      - TAP_S3_CSV_AWS_ENDPOINT_URL=http://localstack:4566
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
      # tap-hubspot (Mock API via DNS redirect)
      - TAP_HUBSPOT_API_KEY=mock-api-key-for-local-development
      # target-postgres (OLAP warehouse)
      - TARGET_POSTGRES_HOST=olap-db
      - TARGET_POSTGRES_PORT=5432
      - TARGET_POSTGRES_USER=warehouse
      - TARGET_POSTGRES_PASSWORD=olap_secret
      - TARGET_POSTGRES_DBNAME=analytics
      # dbt-postgres configuration
      - DBT_PROFILES_DIR=/project/dbt
      # Note: SSL cert for mock-hubspot is patched in entrypoint.sh
      # only for tap-hubspot's virtualenv, not globally
    volumes:
      - ./meltano:/project
      - ./dbt:/project/dbt  # Mount dbt project for dbt-postgres utility
      - meltano-data:/project/.meltano
      - hubspot-certs:/certs:ro  # Self-signed cert from mock-hubspot
    depends_on:
      oltp-db:
        condition: service_healthy
      olap-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
      mock-hubspot:
        condition: service_healthy
    # DNS redirect: HubSpot API calls go to mock-hubspot container
    # Using Docker network alias - mock-hubspot resolves to the container IP
    links:
      - "mock-hubspot:api.hubapi.com"
    # Entrypoint is defined in Dockerfile (installs SSL cert then runs CMD)

  # Terraform runner for LocalStack
  terraform:
    image: hashicorp/terraform:1.7
    container_name: paracelsus-terraform
    working_dir: /terraform
    volumes:
      - ./terraform:/terraform
    environment:
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      localstack:
        condition: service_healthy
    entrypoint: ["tail", "-f", "/dev/null"]  # Keep container running

  # Synthetic data seeder
  seeder:
    build:
      context: ./synthetic_data
      dockerfile: Dockerfile
    container_name: paracelsus-seeder
    environment:
      - OLTP_HOST=oltp-db
      - OLTP_PORT=5432
      - OLTP_USER=admin
      - OLTP_PASSWORD=oltp_secret
      - OLTP_DB=supervision
      - LOCALSTACK_HOST=localstack
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_DEFAULT_REGION=us-east-1
    depends_on:
      oltp-db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - ./synthetic_data:/app

volumes:
  oltp-data:
  olap-data:
  meltano-data:
  hubspot-certs:  # Shared volume for mock HubSpot SSL certificates

networks:
  default:
    name: paracelsus-network
